<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Insights+ | ABC Retail</title>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
  <script src="/data.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet" />

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --ink: #0d0f14;
      --ink-2: #1c2130;
      --ink-3: #2d3448;
      --muted: #5c6480;
      --muted-2: #8892aa;
      --border: rgba(255,255,255,0.08);
      --border-light: rgba(255,255,255,0.05);
      --surface: rgba(255,255,255,0.04);
      --surface-2: rgba(255,255,255,0.07);
      --accent: #4f8ef7;
      --accent-glow: rgba(79,142,247,0.25);
      --accent-2: #34d399;
      --accent-3: #fb923c;
      --danger: #f87171;
      --white: #ffffff;
      --text: rgba(255,255,255,0.92);
      --text-2: rgba(255,255,255,0.60);
      --text-3: rgba(255,255,255,0.35);
      --radius: 16px;
      --radius-sm: 10px;
      --radius-lg: 24px;
      --font-display: 'Syne', sans-serif;
      --font-body: 'DM Sans', sans-serif;
      --nav-h: 60px;
      --chat-h: 72px;
      --keyboard-h: 0px;
    }

    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: var(--font-body);
      background: var(--ink);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      overscroll-behavior: none;
    }

    #root { height: 100%; display: flex; flex-direction: column; }

    /* ‚îÄ‚îÄ Scrollbar ‚îÄ‚îÄ */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--ink-3); border-radius: 4px; }

    /* ‚îÄ‚îÄ Noise overlay ‚îÄ‚îÄ */
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: 0; pointer-events: none;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
      opacity: 0.4;
    }

    /* ‚îÄ‚îÄ INTRO ‚îÄ‚îÄ */
    .intro {
      position: relative; z-index: 10;
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      padding: 2rem;
      background: radial-gradient(ellipse 80% 60% at 50% 0%, rgba(79,142,247,0.15) 0%, transparent 70%),
                  radial-gradient(ellipse 60% 40% at 80% 100%, rgba(52,211,153,0.08) 0%, transparent 60%),
                  var(--ink);
    }

    .intro-inner { max-width: 680px; width: 100%; text-align: center; }

    .intro-badge {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: 100px; padding: 6px 16px;
      font-size: 11px; font-weight: 600; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--accent); margin-bottom: 2rem;
    }

    .intro-badge span { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); display: block; animation: pulse 2s infinite; }

    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(0.8)} }

    .intro-title {
      font-family: var(--font-display);
      font-size: clamp(2.8rem, 8vw, 5rem);
      font-weight: 800; line-height: 1; letter-spacing: -0.03em;
      color: var(--white); margin-bottom: 0.5rem;
    }

    .intro-title span { color: var(--accent); }

    .intro-sub {
      font-size: 1.1rem; color: var(--text-2); margin-bottom: 3rem; line-height: 1.6;
    }

    .intro-stats {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 3rem;
    }

    .intro-stat {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 1.5rem 1rem;
      transition: border-color 0.2s;
    }

    .intro-stat:hover { border-color: rgba(79,142,247,0.3); }

    .intro-stat-num {
      font-family: var(--font-display); font-size: 2.2rem; font-weight: 800;
      color: var(--white); line-height: 1; margin-bottom: 0.25rem;
    }

    .intro-stat-label { font-size: 0.75rem; color: var(--text-2); text-transform: uppercase; letter-spacing: 0.08em; font-weight: 500; }

    .btn-primary {
      display: inline-flex; align-items: center; gap: 10px;
      background: var(--accent); color: var(--white);
      border: none; border-radius: var(--radius-sm);
      padding: 1rem 2rem; font-family: var(--font-body);
      font-size: 1rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s; box-shadow: 0 0 40px var(--accent-glow);
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 0 60px var(--accent-glow); }
    .btn-primary:active { transform: translateY(0); }

    /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
    .login {
      position: relative; z-index: 10;
      min-height: 100vh; display: flex; align-items: center; justify-content: center;
      padding: 2rem;
      background: radial-gradient(ellipse 60% 50% at 30% 50%, rgba(79,142,247,0.1) 0%, transparent 60%), var(--ink);
    }

    .login-card {
      background: var(--ink-2); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 2.5rem;
      width: 100%; max-width: 420px;
    }

    .login-logo {
      width: 48px; height: 48px; border-radius: 12px;
      background: var(--accent); display: flex; align-items: center; justify-content: center;
      font-family: var(--font-display); font-size: 1.2rem; font-weight: 800;
      color: white; margin-bottom: 1.5rem;
    }

    .login-title { font-family: var(--font-display); font-size: 1.8rem; font-weight: 800; margin-bottom: 0.25rem; }
    .login-sub { color: var(--text-2); font-size: 0.9rem; margin-bottom: 2rem; }

    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-2); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.5rem; }

    .form-input {
      width: 100%; background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-sm); padding: 0.75rem 1rem;
      color: var(--text); font-family: var(--font-body); font-size: 0.95rem;
      transition: border-color 0.2s; outline: none;
    }

    .form-input:focus { border-color: var(--accent); }
    .form-input:disabled { opacity: 0.5; }

    .btn-login {
      width: 100%; margin-top: 1.5rem; padding: 0.9rem;
      background: var(--accent); color: white; border: none;
      border-radius: var(--radius-sm); font-family: var(--font-body);
      font-size: 1rem; font-weight: 600; cursor: pointer; transition: opacity 0.2s;
    }

    .btn-login:hover { opacity: 0.9; }
    .btn-login:disabled { opacity: 0.5; cursor: wait; }

    /* ‚îÄ‚îÄ DATA DISCOVERY ‚îÄ‚îÄ */
    .discovery {
      position: relative; z-index: 10;
      height: 100vh; display: flex; flex-direction: column;
      background: radial-gradient(ellipse 70% 40% at 50% 0%, rgba(52,211,153,0.08) 0%, transparent 60%), var(--ink);
    }

    .discovery-header {
      padding: 2rem 2rem 1rem; flex-shrink: 0;
      border-bottom: 1px solid var(--border);
    }

    /* ‚îÄ‚îÄ Discovery Hero ‚îÄ‚îÄ */
    .discovery-hero { padding: 0; }

    .disc-hero-eyebrow {
      display: inline-flex; align-items: center; gap: 8px;
      font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;
      color: var(--accent-2); margin-bottom: 0.75rem;
    }

    .disc-hero-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--accent-2); display: inline-block;
      animation: pulse 2s infinite;
    }

    .disc-hero-title {
      font-family: var(--font-display);
      font-size: clamp(1.4rem, 3.5vw, 2rem);
      font-weight: 800; line-height: 1.15;
      color: var(--white); margin-bottom: 0.4rem;
    }

    .disc-hero-sub { color: var(--text-2); font-size: 0.9rem; }

    /* ‚îÄ‚îÄ Connected stream pill strip ‚îÄ‚îÄ */
    .disc-conn-strip {
      overflow-x: auto; flex-shrink: 0;
      border-bottom: 1px solid var(--border);
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .disc-conn-strip::-webkit-scrollbar { display: none; }

    .disc-conn-inner {
      display: flex; gap: 0.6rem;
      padding: 0.85rem 2rem;
      min-width: max-content;
    }

    .disc-conn-pill {
      display: flex; align-items: center; gap: 6px;
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: 100px; padding: 5px 12px;
      font-size: 0.8rem; font-weight: 500;
      white-space: nowrap; transition: border-color 0.2s;
    }

    .disc-conn-pill:hover { border-color: rgba(79,142,247,0.3); }

    .disc-conn-icon { font-size: 0.95rem; line-height: 1; }

    .disc-conn-count {
      font-size: 0.68rem; font-weight: 600;
      color: var(--text-3); margin-left: 2px;
    }

    /* ‚îÄ‚îÄ Insight stream icard grid ‚îÄ‚îÄ */
    .discovery-body { flex: 1; overflow-y: auto; padding: 1.5rem 2rem; }

    .insight-stream-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }

    .icard {
      background: var(--ink-2); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: hidden;
      transition: border-color 0.2s, transform 0.2s;
    }

    .icard:hover { border-color: rgba(79,142,247,0.25); transform: translateY(-2px); }

    .icard-icon-area {
      padding: 1rem 1rem 0.75rem;
      display: flex; align-items: center; gap: 10px;
    }

    .icard-icon-circle {
      width: 42px; height: 42px; border-radius: 12px; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem;
    }

    .icard-tag {
      font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;
      opacity: 0.75;
    }

    .icard-body { padding: 0 1rem 1rem; }

    .icard-title {
      font-family: var(--font-display); font-size: 0.95rem; font-weight: 800;
      color: var(--white); margin-bottom: 0.4rem; line-height: 1.3;
    }

    .icard-story { font-size: 0.82rem; color: var(--text-2); line-height: 1.55; margin-bottom: 0.85rem; }

    .icard-stat-row {
      display: flex; align-items: baseline; gap: 6px; margin-bottom: 0.75rem;
    }

    .icard-stat-num {
      font-family: var(--font-display); font-size: 1.6rem; font-weight: 800; color: var(--white);
    }

    .icard-stat-label { font-size: 0.78rem; color: var(--text-2); }

    .icard-expand-toggle {
      background: none; border: none; cursor: pointer;
      font-size: 0.75rem; color: var(--text-3); font-family: var(--font-body);
      padding: 0; transition: color 0.2s; display: flex; align-items: center; gap: 4px;
    }

    .icard-expand-toggle:hover { color: var(--text-2); }

    .icard-fields {
      display: flex; flex-wrap: wrap; gap: 5px; margin-top: 0.6rem;
    }

    .field-chip {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 6px; padding: 3px 8px;
      font-size: 0.72rem; font-family: monospace; color: var(--text-2);
    }

    .discovery-footer {
      padding: 1.25rem 2rem; flex-shrink: 0;
      border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; gap: 1rem;
    }

    .discovery-footer-note { font-size: 0.85rem; color: var(--text-2); }
    .discovery-footer-note strong { color: var(--text); }

    /* ‚îÄ‚îÄ CANVAS MODE SCREEN ‚îÄ‚îÄ */
    .cmode-screen {
      position: relative; z-index: 10;
      height: 100vh; display: flex; flex-direction: column;
      background: radial-gradient(ellipse 70% 40% at 50% 0%, rgba(79,142,247,0.1) 0%, transparent 60%), var(--ink);
    }

    .cmode-header {
      padding: 2rem 2rem 1.5rem; flex-shrink: 0;
      border-bottom: 1px solid var(--border);
    }

    .cmode-title {
      font-family: var(--font-display); font-size: clamp(1.4rem, 3.5vw, 2rem);
      font-weight: 800; line-height: 1.15; color: var(--white); margin-bottom: 0.4rem;
    }

    .cmode-sub { color: var(--text-2); font-size: 0.9rem; }

    .cmode-options {
      flex: 1; overflow-y: auto;
      display: flex; align-items: center; justify-content: center;
      padding: 2rem;
      gap: 1.25rem;
      flex-wrap: wrap;
    }

    .cmode-card {
      flex: 1; min-width: 260px; max-width: 360px;
      background: var(--ink-2); border: 1.5px solid var(--border);
      border-radius: var(--radius-lg); padding: 2rem;
      cursor: pointer; transition: all 0.2s;
      display: flex; flex-direction: column; gap: 1rem;
    }

    .cmode-card:hover { transform: translateY(-3px); }

    .cmode-card--preset { border-color: rgba(79,142,247,0.3); }
    .cmode-card--preset:hover { border-color: var(--accent); box-shadow: 0 0 40px rgba(79,142,247,0.15); }

    .cmode-card--custom { border-color: rgba(52,211,153,0.3); border-style: dashed; }
    .cmode-card--custom:hover { border-color: var(--accent-2); box-shadow: 0 0 40px rgba(52,211,153,0.1); }

    .cmode-card-icon { font-size: 2rem; line-height: 1; }

    .cmode-card-tag {
      font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em;
      color: var(--text-3);
    }

    .cmode-card-title {
      font-family: var(--font-display); font-size: 1.3rem; font-weight: 800; color: var(--white);
    }

    .cmode-card-desc { font-size: 0.85rem; color: var(--text-2); line-height: 1.55; }

    .cmode-card-cta {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 0.85rem; font-weight: 600; margin-top: auto;
    }

    .cmode-card--preset .cmode-card-cta { color: var(--accent); }
    .cmode-card--custom .cmode-card-cta { color: var(--accent-2); }

    .cmode-mini-grid {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 4px; border-radius: 8px; overflow: hidden;
    }

    .cmode-mini-block {
      height: 24px; border-radius: 4px; opacity: 0.7;
    }

    .cmode-add-preview {
      border: 1.5px dashed var(--border); border-radius: 8px;
      height: 52px; display: flex; align-items: center; justify-content: center;
      color: var(--text-3); font-size: 1.5rem;
    }

    /* ‚îÄ‚îÄ CANVAS BUILDER ‚îÄ‚îÄ */
    .canvas-builder {
      position: relative; z-index: 10;
      height: 100vh; display: flex; flex-direction: column;
      background: var(--ink);
    }

    .cb-header {
      height: var(--nav-h); flex-shrink: 0;
      background: rgba(13,15,20,0.9); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center;
      padding: 0 1.25rem; gap: 12px; z-index: 50;
    }

    .cb-back {
      width: 32px; height: 32px; border-radius: 8px; flex-shrink: 0;
      background: var(--surface); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text-2); font-size: 0.85rem;
      transition: all 0.2s;
    }

    .cb-back:hover { background: var(--surface-2); color: var(--text); }

    .cb-grid-area { flex: 1; overflow-y: auto; padding: 1.25rem; }

    .cb-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.85rem;
    }

    .cb-widget-tile {
      background: var(--ink-2); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 1rem;
      display: flex; flex-direction: column; gap: 8px;
      animation: fadeUp 0.3s ease both;
    }

    .cb-tile-top {
      display: flex; align-items: flex-start; justify-content: space-between;
    }

    .cb-tile-icon { font-size: 1.4rem; line-height: 1; }

    .cb-tile-remove {
      width: 24px; height: 24px; border-radius: 6px; flex-shrink: 0;
      background: var(--surface); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text-3); font-size: 0.75rem;
      transition: all 0.2s;
    }

    .cb-tile-remove:hover { background: rgba(248,113,113,0.15); border-color: var(--danger); color: var(--danger); }

    .cb-tile-title { font-weight: 700; font-size: 0.85rem; line-height: 1.3; color: var(--text); }
    .cb-tile-meta { font-size: 0.72rem; color: var(--text-3); }

    .cb-add-card {
      border: 1.5px dashed var(--border); border-radius: var(--radius);
      min-height: 120px; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 6px;
      cursor: pointer; transition: all 0.2s; color: var(--text-3);
    }

    .cb-add-card:hover { border-color: var(--accent); color: var(--accent); background: rgba(79,142,247,0.04); }

    .cb-add-card-icon { font-size: 1.5rem; }
    .cb-add-card-label { font-size: 0.8rem; font-weight: 600; }

    /* ‚îÄ‚îÄ WIDGET BUILDER OVERLAY ‚îÄ‚îÄ */
    .wbuilder-overlay {
      position: fixed; inset: 0; z-index: 400;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
      display: flex; align-items: flex-end; justify-content: center;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    .wbuilder-panel {
      width: 100%; max-width: 560px;
      background: var(--ink-2); border: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      display: flex; flex-direction: column;
      max-height: calc(92vh - var(--keyboard-h, 0px));
      animation: slideUp 0.3s cubic-bezier(0.32,0.72,0,1);
    }

    @media (min-width: 600px) {
      .wbuilder-overlay { align-items: center; }
      .wbuilder-panel { border-radius: 24px; max-height: 85vh; }
    }

    @keyframes slideUp { from{transform:translateY(40px);opacity:0} to{transform:translateY(0);opacity:1} }

    .wbuilder-head {
      padding: 1.25rem 1.25rem 0.75rem; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
    }

    .wbuilder-step-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-3); margin-bottom: 4px; }
    .wbuilder-head-title { font-weight: 700; font-size: 1rem; }

    .wbuilder-step-bar { display: flex; gap: 5px; align-items: center; }

    .wbuilder-step-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--border); transition: background 0.2s;
    }

    .wbuilder-step-dot.active { background: var(--accent); }
    .wbuilder-step-dot.done { background: var(--accent-2); }

    .wbuilder-body { flex: 1; overflow-y: auto; padding: 1.25rem; }

    .wbuilder-q { font-weight: 700; font-size: 1rem; margin-bottom: 0.3rem; }
    .wbuilder-hint { font-size: 0.82rem; color: var(--text-2); margin-bottom: 1.25rem; }

    .wbuilder-metric-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;
    }

    .wbuilder-metric-tile {
      background: var(--surface); border: 1.5px solid var(--border);
      border-radius: var(--radius); padding: 1rem;
      cursor: pointer; transition: all 0.2s;
    }

    .wbuilder-metric-tile:hover,
    .wbuilder-metric-tile.selected { border-color: var(--accent); background: rgba(79,142,247,0.08); }

    .wbuilder-metric-tile-name { font-weight: 700; font-size: 0.9rem; margin-bottom: 4px; }
    .wbuilder-metric-tile-sub { font-size: 0.75rem; color: var(--text-2); }
    .wbuilder-metric-tile-count { font-size: 0.7rem; color: var(--text-3); margin-top: 6px; }

    .wbuilder-field-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem;
    }

    .wbuilder-field-tile {
      background: var(--surface); border: 1.5px solid var(--border);
      border-radius: var(--radius); padding: 1rem;
      cursor: pointer; transition: all 0.2s;
    }

    .wbuilder-field-tile:hover,
    .wbuilder-field-tile.selected { border-color: var(--accent); background: rgba(79,142,247,0.08); }

    .wbuilder-field-tile-label { font-weight: 700; font-size: 0.9rem; margin-bottom: 2px; }
    .wbuilder-field-tile-key { font-size: 0.72rem; color: var(--text-3); font-family: monospace; margin-bottom: 6px; }
    .wbuilder-field-tile-sample { font-size: 0.78rem; color: var(--accent-2); font-weight: 600; }

    .wbuilder-chart-grid {
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;
    }

    .wbuilder-chart-tile {
      background: var(--surface); border: 1.5px solid var(--border);
      border-radius: var(--radius); padding: 1.1rem 1rem;
      cursor: pointer; transition: all 0.2s;
      display: flex; flex-direction: column; gap: 6px;
    }

    .wbuilder-chart-tile:hover,
    .wbuilder-chart-tile.selected { border-color: var(--accent); background: rgba(79,142,247,0.08); }

    .wbuilder-chart-tile-icon { font-size: 1.6rem; line-height: 1; }
    .wbuilder-chart-tile-label { font-weight: 700; font-size: 0.9rem; }
    .wbuilder-chart-tile-hint { font-size: 0.75rem; color: var(--text-2); }

    .wbuilder-confirm-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 1.25rem; display: flex; flex-direction: column; gap: 10px;
    }

    .wbuilder-confirm-row {
      display: flex; justify-content: space-between; align-items: baseline;
      font-size: 0.85rem;
    }

    .wbuilder-confirm-row span:first-child { color: var(--text-3); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.07em; }
    .wbuilder-confirm-row span:last-child { font-weight: 600; color: var(--text); }

    .wbuilder-footer {
      padding: 1rem 1.25rem;
      padding-bottom: max(1rem, env(safe-area-inset-bottom));
      border-top: 1px solid var(--border);
      display: flex; gap: 10px; flex-shrink: 0;
    }

    .wbuilder-back {
      padding: 0.75rem 1.25rem; background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius-sm); color: var(--text-2); font-family: var(--font-body);
      font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }

    .wbuilder-back:hover { background: var(--surface-2); color: var(--text); }

    /* ‚îÄ‚îÄ DASHBOARD LAYOUT ‚îÄ‚îÄ */
    .dashboard {
      display: flex; flex-direction: column;
      height: 100vh; position: relative; z-index: 10;
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
    .nav {
      height: var(--nav-h); flex-shrink: 0;
      background: rgba(13,15,20,0.9); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center;
      padding: 0 1.25rem; gap: 12px; z-index: 50;
    }

    .nav-logo {
      width: 32px; height: 32px; border-radius: 8px;
      background: var(--accent); display: flex; align-items: center; justify-content: center;
      font-family: var(--font-display); font-size: 0.85rem; font-weight: 800; color: white;
      flex-shrink: 0;
    }

    .nav-title { font-family: var(--font-display); font-size: 1rem; font-weight: 800; flex: 1; }
    .nav-sub { font-size: 0.7rem; color: var(--text-2); display: none; }

    @media (min-width: 480px) { .nav-sub { display: block; } }

    .nav-pill {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 100px; padding: 4px 12px;
      font-size: 0.72rem; font-weight: 600; color: var(--accent-2);
      white-space: nowrap;
    }

    /* ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ */
    .canvas {
      flex: 1; overflow-y: auto; overflow-x: hidden;
      padding: 1rem;
      padding-bottom: calc(var(--chat-h) + 1rem);
    }

    .canvas-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    @media (min-width: 640px) {
      .canvas-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (min-width: 1100px) {
      .canvas-grid { grid-template-columns: repeat(3, 1fr); }
    }

    /* wide card spans 2 cols on larger screens */
    .widget-wide { grid-column: 1 / -1; }

    @media (min-width: 1100px) {
      .widget-wide { grid-column: span 2; }
    }

    /* ‚îÄ‚îÄ WIDGET ‚îÄ‚îÄ */
    .widget {
      background: var(--ink-2); border: 1px solid var(--border);
      border-radius: var(--radius); overflow: hidden;
      display: flex; flex-direction: column; min-height: 280px;
      transition: border-color 0.2s;
    }

    .widget:hover { border-color: rgba(79,142,247,0.2); }

    .widget-head {
      padding: 1rem 1rem 0.5rem;
      display: flex; align-items: flex-start; justify-content: space-between; gap: 8px;
      flex-shrink: 0;
    }

    .widget-category { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted-2); margin-bottom: 3px; }
    .widget-title { font-weight: 700; font-size: 0.95rem; color: var(--text); line-height: 1.3; }
    .widget-kpi { font-family: var(--font-display); font-size: 1.6rem; font-weight: 800; color: var(--white); margin-top: 2px; }
    .widget-kpi-sub { font-size: 0.72rem; color: var(--text-2); margin-top: 1px; }

    .widget-chat-btn {
      width: 30px; height: 30px; border-radius: 8px; flex-shrink: 0;
      background: var(--surface); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; color: var(--text-2); font-size: 0.8rem;
    }

    .widget-chat-btn:hover { background: var(--accent); border-color: var(--accent); color: white; }

    .widget-chart { flex: 1; padding: 0.5rem 0.75rem 0.75rem; min-height: 160px; }

    /* ‚îÄ‚îÄ TREND BADGE ‚îÄ‚îÄ */
    .trend { display: inline-flex; align-items: center; gap: 4px; font-size: 0.72rem; font-weight: 600; padding: 2px 8px; border-radius: 100px; margin-top: 4px; }
    .trend.up { background: rgba(52,211,153,0.1); color: var(--accent-2); }
    .trend.down { background: rgba(248,113,113,0.1); color: var(--danger); }

    /* ‚îÄ‚îÄ CHAT BAR (bottom, mobile-first) ‚îÄ‚îÄ */
    .chat-bar {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
      height: var(--chat-h);
      background: rgba(13,15,20,0.95); backdrop-filter: blur(24px);
      border-top: 1px solid var(--border);
      padding: 0.75rem 1rem;
      padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
      display: flex; align-items: center; gap: 10px;
    }

    .chat-input-wrap {
      flex: 1; display: flex; align-items: center;
      background: var(--surface-2); border: 1px solid var(--border);
      border-radius: 100px; padding: 0 1rem; gap: 8px;
      transition: border-color 0.2s;
      cursor: pointer;
    }

    .chat-input-placeholder {
      flex: 1; color: var(--text-3); font-size: 0.9rem;
      padding: 0.6rem 0; pointer-events: none; user-select: none;
    }

    .chat-send {
      width: 40px; height: 40px; border-radius: 50%; flex-shrink: 0;
      background: var(--accent); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 1rem; transition: all 0.2s;
      box-shadow: 0 0 20px var(--accent-glow);
    }

    .chat-send:hover { transform: scale(1.05); }
    .chat-send:disabled { opacity: 0.4; cursor: default; transform: none; }

    /* ‚îÄ‚îÄ CHAT DRAWER (slides up from bottom) ‚îÄ‚îÄ */
    .chat-drawer-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s;
    }

    .chat-drawer-overlay.open { opacity: 1; pointer-events: all; }

    .chat-drawer {
      position: fixed; left: 0; right: 0; z-index: 201;
      bottom: var(--keyboard-h, 0px);
      max-height: calc(100vh - var(--keyboard-h, 0px) - 44px);
      height: min(75vh, 600px);
      background: var(--ink-2); border-top: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      display: flex; flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    }

    .chat-drawer.open { transform: translateY(0); }

    .drawer-handle {
      width: 40px; height: 4px; border-radius: 4px;
      background: var(--border); margin: 12px auto 0;
      flex-shrink: 0;
    }

    .drawer-head {
      padding: 1rem 1.25rem 0.75rem;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: space-between;
    }

    .drawer-head-info {}
    .drawer-head-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--accent); margin-bottom: 2px; }
    .drawer-head-title { font-weight: 700; font-size: 1rem; }

    .drawer-close {
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--surface); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text-2); font-size: 1rem;
      transition: all 0.2s;
    }

    .drawer-close:hover { background: var(--surface-2); color: var(--text); }

    .drawer-messages {
      flex: 1; overflow-y: auto;
      padding: 1rem 1.25rem;
      display: flex; flex-direction: column; gap: 12px;
    }

    .msg { display: flex; align-items: flex-end; gap: 8px; }
    .msg.user { flex-direction: row-reverse; }

    .msg-avatar {
      width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
      background: var(--surface-2); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.75rem;
    }

    .msg.user .msg-avatar { background: var(--accent); }

    .msg-bubble {
      max-width: 78%; padding: 0.65rem 0.9rem;
      border-radius: 16px; font-size: 0.875rem; line-height: 1.55;
    }

    .msg.ai .msg-bubble { background: var(--surface-2); border: 1px solid var(--border); border-bottom-left-radius: 4px; color: var(--text); }
    .msg.user .msg-bubble { background: var(--accent); border-bottom-right-radius: 4px; color: white; }

    .typing-dots { display: flex; gap: 4px; align-items: center; padding: 0.65rem 0.9rem; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--muted-2); animation: blink 1.4s infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%,80%,100%{transform:scale(0.8);opacity:0.4} 40%{transform:scale(1);opacity:1} }

    .drawer-input {
      padding: 0.75rem 1.25rem;
      padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
      border-top: 1px solid var(--border);
      display: flex; gap: 10px; flex-shrink: 0;
    }

    .drawer-input-wrap {
      flex: 1; display: flex; align-items: center;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 100px; padding: 0 1rem; gap: 8px;
      transition: border-color 0.2s;
    }

    .drawer-input-wrap:focus-within { border-color: var(--accent); }

    .drawer-input-field {
      flex: 1; background: transparent; border: none; outline: none;
      color: var(--text); font-family: var(--font-body); font-size: 0.875rem;
      padding: 0.6rem 0;
    }

    .drawer-input-field::placeholder { color: var(--text-3); }

    .drawer-send {
      width: 38px; height: 38px; border-radius: 50%; flex-shrink: 0;
      background: var(--accent); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 0.9rem; transition: all 0.2s;
    }

    .drawer-send:hover { opacity: 0.85; }
    .drawer-send:disabled { opacity: 0.35; cursor: default; }

    /* ‚îÄ‚îÄ WIDGET CHAT MODAL ‚îÄ‚îÄ */
    .wchat-overlay {
      position: fixed; inset: 0; z-index: 300;
      background: rgba(0,0,0,0.7); backdrop-filter: blur(6px);
      display: flex; align-items: flex-end; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.2s;
    }

    .wchat-overlay.open { opacity: 1; pointer-events: all; }

    .wchat-sheet {
      width: 100%; max-width: 540px;
      background: var(--ink-2); border: 1px solid var(--border);
      border-radius: 24px 24px 0 0;
      display: flex; flex-direction: column;
      bottom: var(--keyboard-h, 0px);
      max-height: calc(100vh - var(--keyboard-h, 0px) - 44px);
      height: min(70vh, 520px);
      transform: translateY(20px); transition: transform 0.25s;
    }

    .wchat-overlay.open .wchat-sheet { transform: translateY(0); }

    @media (min-width: 540px) {
      .wchat-overlay { align-items: center; }
      .wchat-sheet { border-radius: 24px; height: min(70vh, 520px); }
    }

    .wchat-head {
      padding: 1.25rem; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
    }

    .wchat-head-label { font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted-2); margin-bottom: 2px; }
    .wchat-head-title { font-weight: 700; font-size: 0.95rem; }

    .wchat-close {
      width: 32px; height: 32px; border-radius: 50%;
      background: var(--surface); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text-2); font-size: 1rem; transition: all 0.2s;
    }

    .wchat-close:hover { background: var(--danger); border-color: var(--danger); color: white; }

    .wchat-messages {
      flex: 1; overflow-y: auto; padding: 1rem 1.25rem;
      display: flex; flex-direction: column; gap: 10px;
    }

    .wchat-empty { text-align: center; padding: 2rem 1rem; }
    .wchat-empty-title { font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text); }
    .wchat-empty-sub { font-size: 0.8rem; color: var(--text-2); margin-bottom: 1.25rem; }

    .suggestions { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }

    .suggestion-chip {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 100px; padding: 6px 14px;
      font-size: 0.78rem; font-family: var(--font-body); color: var(--text-2);
      cursor: pointer; transition: all 0.2s;
    }

    .suggestion-chip:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }

    .wchat-input-row {
      padding: 0.75rem 1.25rem;
      padding-bottom: max(0.75rem, env(safe-area-inset-bottom));
      border-top: 1px solid var(--border);
      display: flex; gap: 8px; flex-shrink: 0;
    }

    .wchat-field {
      flex: 1; background: var(--surface); border: 1px solid var(--border);
      border-radius: 100px; padding: 0.6rem 1rem;
      color: var(--text); font-family: var(--font-body); font-size: 0.875rem;
      outline: none; transition: border-color 0.2s;
    }

    .wchat-field:focus { border-color: var(--accent); }
    .wchat-field::placeholder { color: var(--text-3); }

    .wchat-send {
      width: 38px; height: 38px; border-radius: 50%; flex-shrink: 0;
      background: var(--accent); border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      color: white; font-size: 0.9rem; transition: opacity 0.2s;
    }

    .wchat-send:hover { opacity: 0.85; }
    .wchat-send:disabled { opacity: 0.35; cursor: default; }

    /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
    @keyframes fadeUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
    .fade-up { animation: fadeUp 0.4s ease both; }
    .fade-up-2 { animation: fadeUp 0.4s 0.1s ease both; }
    .fade-up-3 { animation: fadeUp 0.4s 0.2s ease both; }

    /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    /* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
    @media (max-width: 480px) {
      .nav-pill { display: none; }
      .widget-kpi { font-size: 2rem; }
      .discovery-footer { flex-direction: column; }
      .discovery-footer .btn-primary { width: 100%; justify-content: center; }
      .cmode-options { padding: 1rem 1.25rem 2rem; }
      .canvas { padding: 0.75rem; }
      .canvas-grid { gap: 0.75rem; }
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback, useMemo } = React;
const {
  BarChart, Bar, LineChart, Line, PieChart, Pie, Cell,
  XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend
} = Recharts;

const D = window.ABC_DATA;

// ‚îÄ‚îÄ Icons (inline SVG via emoji-like helpers) ‚îÄ‚îÄ
const Icon = ({ name, size = 16 }) => {
  const icons = {
    send: '‚û§',
    bot: '‚óà',
    user: '‚óè',
    close: '‚úï',
    arrow: '‚Üí',
    spark: '‚ú¶',
    up: '‚ñ≤',
    down: '‚ñº',
    receipt: 'üßæ',
    tag: 'üè∑',
    users: 'üë•',
    store: 'üè™',
    package: 'üì¶',
    'user-check': '‚úÖ',
    chart: 'üìä',
    info: '‚Ñπ',
    back: '‚Üê',
    plus: '+',
  };
  return <span style={{ fontSize: size, lineHeight: 1 }}>{icons[name] || '‚óÜ'}</span>;
};

// ‚îÄ‚îÄ Colour palette for charts ‚îÄ‚îÄ
const PALETTE = ['#4f8ef7','#34d399','#fb923c','#a78bfa','#f472b6','#fbbf24'];

// ‚îÄ‚îÄ Number formatter ‚îÄ‚îÄ
const fmt = (n, prefix = '') => {
  if (n >= 1000000) return `${prefix}${(n/1000000).toFixed(1)}M`;
  if (n >= 1000) return `${prefix}${(n/1000).toFixed(0)}K`;
  return `${prefix}${n.toLocaleString()}`;
};

// ‚îÄ‚îÄ Markdown-lite renderer ‚îÄ‚îÄ
const renderMd = (text) => text
  .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
  .replace(/\*(.*?)\*/g, '<em>$1</em>')
  .replace(/\n/g, '<br/>');

// ‚îÄ‚îÄ TABLE_STORIES ‚îÄ‚îÄ
const TABLE_STORIES = {
  transactions: {
    tag: 'Sales activity',
    title: 'Every sale, captured in real time',
    story: 'From the moment a customer taps their card to the moment the receipt prints, every transaction lands here. This is the heartbeat of your business ‚Äî 22,000+ events, searchable and queryable.',
    accentColor: '#4f8ef7',
    bgGradient: 'rgba(79,142,247,0.12)',
    emoji: 'üßæ',
    statLabel: 'transactions tracked',
  },
  products: {
    tag: 'Product catalog',
    title: 'Your full range, margin and all',
    story: 'Every SKU from Slim Fit Denim to Canvas Sneakers lives here, complete with cost price, sell price, and supplier. Filter by category, drill into margin ‚Äî your catalogue is fully mapped.',
    accentColor: '#fb923c',
    bgGradient: 'rgba(251,146,60,0.12)',
    emoji: 'üè∑Ô∏è',
    statLabel: 'products catalogued',
  },
  customers: {
    tag: 'Customer base',
    title: '10,000+ shoppers, fully profiled',
    story: 'VIPs spending LKR 124K lifetime, new joiners barely warmed up, at-risk regulars quietly drifting ‚Äî every customer segment is here, ready to target with the right message.',
    accentColor: '#34d399',
    bgGradient: 'rgba(52,211,153,0.12)',
    emoji: 'üë•',
    statLabel: 'customers profiled',
  },
  stores: {
    tag: 'Store network',
    title: 'All 6 locations, side by side',
    story: 'City Centre vs Marina Point. Colombo vs Galle. Compare footfall, conversion, and average basket across every door in your network ‚Äî all in one view.',
    accentColor: '#a78bfa',
    bgGradient: 'rgba(167,139,250,0.12)',
    emoji: 'üè™',
    statLabel: 'stores connected',
  },
  inventory: {
    tag: 'Stock intelligence',
    title: 'Know before you run out ‚Äî or overstock',
    story: 'Tops are 920 units over optimal. Footwear is 220 short. Daily snapshots per category give you early warning on every stockroom, so you can act before it hits revenue.',
    accentColor: '#fbbf24',
    bgGradient: 'rgba(251,191,36,0.12)',
    emoji: 'üì¶',
    statLabel: 'daily stock snapshots',
  },
  staff: {
    tag: 'Team performance',
    title: 'Your 77 people, productively visible',
    story: 'North Gate leads with 381 transactions per staff. Marina Point trails at 302. Tenure, training hours, and satisfaction scores ‚Äî know where your team shines and where to invest.',
    accentColor: '#f472b6',
    bgGradient: 'rgba(244,114,182,0.12)',
    emoji: 'üë§',
    statLabel: 'staff members tracked',
  },
};

// ‚îÄ‚îÄ FIELD_LABELS ‚îÄ‚îÄ
const FIELD_LABELS = {
  revenue: 'Revenue',
  transactions: 'Transactions',
  avg_basket: 'Avg Basket Value',
  returns: 'Returns',
  footfall: 'Footfall',
  conversion: 'Conversion Rate',
  variance_vs_avg: 'Variance vs Avg',
  units: 'Units Sold',
  margin_pct: 'Margin %',
  growth_pct: 'Growth %',
  count: 'Customer Count',
  pct: 'Percentage',
  avg_visits_month: 'Avg Visits / Month',
  ltv: 'Lifetime Value',
  current_stock: 'Current Stock',
  optimal_stock: 'Optimal Stock',
  reorder_point: 'Reorder Point',
  days_of_supply: 'Days of Supply',
  overstock_units: 'Overstock Units',
  headcount: 'Headcount',
  avg_transactions_per_staff: 'Transactions / Staff',
  training_hrs: 'Training Hours',
  satisfaction_score: 'Satisfaction Score',
  members: 'Members',
  avg_basket: 'Avg Basket',
  visits_per_month: 'Visits / Month',
  retention_rate: 'Retention Rate',
};

// ‚îÄ‚îÄ CHART_TYPES ‚îÄ‚îÄ
const CHART_TYPES = [
  { id: 'bar', label: 'Bar Chart', icon: '‚ñä', hint: 'Compare values side by side' },
  { id: 'hbar', label: 'H-Bar Chart', icon: '‚ñ¨', hint: 'Great for ranked lists' },
  { id: 'line', label: 'Line Chart', icon: 'üìà', hint: 'Show trends over time' },
  { id: 'donut', label: 'Donut Chart', icon: '‚óé', hint: 'Show proportions & share' },
];

// ‚îÄ‚îÄ introspectData ‚îÄ‚îÄ
const introspectData = () => {
  const skip = new Set(['tables', 'meta', 'stores', 'customers', 'products']);
  return Object.entries(D)
    .filter(([key, val]) => !skip.has(key) && Array.isArray(val) && val.length > 0)
    .map(([key, rows]) => {
      const first = rows[0];
      const numericFields = Object.entries(first)
        .filter(([, v]) => typeof v === 'number')
        .map(([k]) => k);
      const labelField = Object.entries(first)
        .find(([, v]) => typeof v === 'string')?.[0] || null;

      if (!numericFields.length) return null;

      const labelMap = {
        monthly_revenue: 'Monthly Revenue',
        store_performance: 'Store Performance',
        category_revenue: 'Category Revenue',
        customer_segments: 'Customer Segments',
        loyalty_impact: 'Loyalty Tiers',
        inventory: 'Inventory Levels',
        peak_hours: 'Peak Hours',
        payment_methods: 'Payment Methods',
        staff_performance: 'Staff Performance',
      };

      return {
        key,
        label: labelMap[key] || key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
        rows: rows.length,
        numericFields,
        labelField,
        firstRow: first,
      };
    })
    .filter(Boolean);
};

// ‚îÄ‚îÄ buildWidgetConfig ‚îÄ‚îÄ
const buildWidgetConfig = ({ metric, yField, chartType }) => {
  const data = D[metric.key];
  let chartData = data;
  let chartCfg = {};
  const fieldLabel = FIELD_LABELS[yField] || yField;

  if (chartType === 'donut') {
    chartData = data.map(row => ({
      name: metric.labelField ? String(row[metric.labelField]) : String(Object.values(row)[0]),
      value: Number(row[yField]) || 0,
    }));
    chartCfg = { value: 'value', name: 'name' };
  } else if (chartType === 'hbar') {
    chartCfg = {
      y: metric.labelField || Object.keys(data[0])[0],
      x: yField,
    };
  } else {
    chartCfg = {
      x: metric.labelField || Object.keys(data[0])[0],
      y: yField,
    };
  }

  const maxVal = Math.max(...data.map(r => Number(r[yField]) || 0));
  const kpi = fmt(maxVal);

  return {
    id: `custom-${metric.key}-${yField}-${Date.now()}`,
    category: metric.label,
    title: `${fieldLabel} ‚Äî ${metric.label}`,
    kpi,
    kpiSub: `Peak ${fieldLabel.toLowerCase()}`,
    chartType,
    data: chartData,
    chartCfg,
    suggestions: [
      `What drives the highest ${fieldLabel.toLowerCase()}?`,
      `Which entry has the lowest ${fieldLabel.toLowerCase()}?`,
      `Summarise the trend in ${fieldLabel.toLowerCase()}.`,
    ],
  };
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTRO SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const IntroScreen = ({ onContinue }) => {
  const totalRevenue = D.monthly_revenue.reduce((s, m) => s + m.revenue, 0);
  const totalTx = D.monthly_revenue.reduce((s, m) => s + m.transactions, 0);

  return (
    <div className="intro">
      <div className="intro-inner">
        <div className="intro-badge fade-up"><span />{D.meta.company} ¬∑ {D.meta.industry}</div>
        <h1 className="intro-title fade-up-2">Your POS data,<br /><span>finally intelligent</span></h1>
        <p className="intro-sub fade-up-3">Insights+ turns raw point-of-sale records into a living dashboard with AI you can actually talk to.</p>

        <div className="intro-stats fade-up-3">
          <div className="intro-stat">
            <div className="intro-stat-num">{D.stores.length}</div>
            <div className="intro-stat-label">Store locations</div>
          </div>
          <div className="intro-stat">
            <div className="intro-stat-num">{fmt(totalTx)}</div>
            <div className="intro-stat-label">Transactions loaded</div>
          </div>
          <div className="intro-stat">
            <div className="intro-stat-num">{fmt(totalRevenue, 'LKR ')}</div>
            <div className="intro-stat-label">Revenue tracked</div>
          </div>
        </div>

        <button className="btn-primary fade-up-3" onClick={onContinue}>
          <Icon name="spark" /> Explore your data
        </button>
      </div>
    </div>
  );
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LoginScreen = ({ onLogin }) => {
  const [loading, setLoading] = useState(false);

  const handleSubmit = (e) => {
    e.preventDefault();
    setLoading(true);
    setTimeout(onLogin, 1200);
  };

  return (
    <div className="login">
      <div className="login-card fade-up">
        <div className="login-logo">I+</div>
        <h1 className="login-title">Sign in</h1>
        <p className="login-sub">Access your analytics workspace</p>

        <form onSubmit={handleSubmit}>
          <div className="form-group">
            <label className="form-label">Organisation</label>
            <input className="form-input" value={D.meta.company} disabled />
          </div>
          <div className="form-group">
            <label className="form-label">Email</label>
            <input className="form-input" type="email" defaultValue="admin@abcretail.lk" />
          </div>
          <div className="form-group">
            <label className="form-label">Password</label>
            <input className="form-input" type="password" defaultValue="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
          <button type="submit" className="btn-login" disabled={loading}>
            {loading ? 'Authenticating‚Ä¶' : 'Access Dashboard'}
          </button>
        </form>
      </div>
    </div>
  );
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA DISCOVERY SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DiscoveryScreen = ({ onBuild }) => {
  const [expanded, setExpanded] = useState(null);

  const totalRecords = D.tables.reduce((s, t) => s + t.record_count, 0);

  return (
    <div className="discovery">
      <div className="discovery-header">
        <div className="discovery-hero">
          <div className="disc-hero-eyebrow">
            <span className="disc-hero-dot" /> Live connection established
          </div>
          <h2 className="disc-hero-title">Here's every data stream flowing<br />into your dashboard</h2>
          <p className="disc-hero-sub">{D.meta.company} ¬∑ {D.meta.period}</p>
        </div>
      </div>

      <div className="disc-conn-strip">
        <div className="disc-conn-inner">
          {D.tables.map(t => {
            const story = TABLE_STORIES[t.id];
            return (
              <div className="disc-conn-pill" key={t.id}>
                <span className="disc-conn-icon">{story?.emoji || 'üìã'}</span>
                <span>{t.label}</span>
                <span className="disc-conn-count">{t.record_count.toLocaleString()}</span>
              </div>
            );
          })}
        </div>
      </div>

      <div className="discovery-body">
        <div className="insight-stream-grid">
          {D.tables.map((t, i) => {
            const story = TABLE_STORIES[t.id] || {};
            const isOpen = expanded === t.id;
            return (
              <div
                className="icard fade-up"
                key={t.id}
                style={{ animationDelay: `${i * 0.06}s` }}
              >
                <div
                  className="icard-icon-area"
                  style={{ background: story.bgGradient || 'var(--surface)' }}
                >
                  <div
                    className="icard-icon-circle"
                    style={{ background: story.bgGradient || 'var(--surface-2)' }}
                  >
                    {story.emoji || 'üìã'}
                  </div>
                  <div
                    className="icard-tag"
                    style={{ color: story.accentColor || 'var(--text-3)' }}
                  >
                    {story.tag || t.label}
                  </div>
                </div>

                <div className="icard-body">
                  <div className="icard-title">{story.title || t.label}</div>
                  <p className="icard-story">{story.story || t.description}</p>

                  <div className="icard-stat-row">
                    <span
                      className="icard-stat-num"
                      style={{ color: story.accentColor || 'var(--white)' }}
                    >
                      {t.record_count.toLocaleString()}
                    </span>
                    <span className="icard-stat-label">{story.statLabel || 'records'}</span>
                  </div>

                  <button
                    className="icard-expand-toggle"
                    onClick={() => setExpanded(isOpen ? null : t.id)}
                  >
                    {t.fields.length} fields available {isOpen ? '‚ñ≤' : '‚ñº'}
                  </button>

                  {isOpen && (
                    <div className="icard-fields">
                      {t.fields.map(f => (
                        <span className="field-chip" key={f}>{f}</span>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      </div>

      <div className="discovery-footer">
        <p className="discovery-footer-note">
          <strong>{D.tables.length} data streams</strong> ¬∑ {totalRecords.toLocaleString()} total records ¬∑ updated live from your POS
        </p>
        <button className="btn-primary" onClick={onBuild}>
          Choose my canvas <Icon name="arrow" />
        </button>
      </div>
    </div>
  );
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CANVAS MODE SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CanvasModeScreen = ({ onPreset, onCustom }) => (
  <div className="cmode-screen">
    <div className="cmode-header">
      <h2 className="cmode-title">How do you want to build your canvas?</h2>
      <p className="cmode-sub">Pick the preset layout or assemble your own widgets from scratch.</p>
    </div>

    <div className="cmode-options">
      <div className="cmode-card cmode-card--preset fade-up" onClick={onPreset}>
        <div className="cmode-card-icon">‚ö°</div>
        <div className="cmode-card-tag">Ready for you</div>
        <div className="cmode-card-title">Preset Canvas</div>
        <p className="cmode-card-desc">6 hand-picked widgets covering revenue, stores, customers, products, inventory, and operations. Jump straight in.</p>
        <div className="cmode-mini-grid">
          {PALETTE.map((c, i) => (
            <div key={i} className="cmode-mini-block" style={{ background: c }} />
          ))}
        </div>
        <div className="cmode-card-cta">Launch preset dashboard ‚Üí</div>
      </div>

      <div className="cmode-card cmode-card--custom fade-up-2" onClick={onCustom}>
        <div className="cmode-card-icon">üß©</div>
        <div className="cmode-card-tag">Custom canvas</div>
        <div className="cmode-card-title">Build Your Own</div>
        <p className="cmode-card-desc">Choose your data sources, pick the metrics that matter, and select chart types. Your dashboard, your way.</p>
        <div className="cmode-add-preview">Ôºã</div>
        <div className="cmode-card-cta">Start building ‚Üí</div>
      </div>
    </div>
  </div>
);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIDGET BUILDER (4-step wizard)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WidgetBuilder = ({ onAdd, onClose }) => {
  const [step, setStep] = useState(0);
  const [selectedMetric, setSelectedMetric] = useState(null);
  const [selectedField, setSelectedField] = useState(null);
  const [selectedChart, setSelectedChart] = useState(null);

  const metrics = useMemo(() => introspectData(), []);

  const steps = ['Data source', 'Metric', 'Chart type', 'Confirm'];

  const canNext = [
    !!selectedMetric,
    !!selectedField,
    !!selectedChart,
    true,
  ][step];

  const handleNext = () => {
    if (step < 3) setStep(s => s + 1);
    else {
      onAdd(buildWidgetConfig({ metric: selectedMetric, yField: selectedField, chartType: selectedChart }));
    }
  };

  const handleBack = () => {
    if (step === 0) onClose();
    else setStep(s => s - 1);
  };

  return (
    <div className="wbuilder-overlay" onClick={onClose}>
      <div className="wbuilder-panel" onClick={e => e.stopPropagation()}>
        <div className="wbuilder-head">
          <div>
            <div className="wbuilder-step-label">Step {step + 1} of 4 ‚Äî {steps[step]}</div>
            <div className="wbuilder-head-title">
              {['Choose a data source', 'Choose a metric', 'Choose chart type', 'Confirm widget'][step]}
            </div>
          </div>
          <div style={{ display: 'flex', alignItems: 'center', gap: 12 }}>
            <div className="wbuilder-step-bar">
              {steps.map((_, i) => (
                <div
                  key={i}
                  className={`wbuilder-step-dot ${i < step ? 'done' : i === step ? 'active' : ''}`}
                />
              ))}
            </div>
            <button className="drawer-close" onClick={onClose}><Icon name="close" /></button>
          </div>
        </div>

        <div className="wbuilder-body">
          {step === 0 && (
            <>
              <div className="wbuilder-q">What data do you want to visualise?</div>
              <div className="wbuilder-hint">Each source has different metrics you can chart.</div>
              <div className="wbuilder-metric-grid">
                {metrics.map(m => (
                  <div
                    key={m.key}
                    className={`wbuilder-metric-tile ${selectedMetric?.key === m.key ? 'selected' : ''}`}
                    onClick={() => { setSelectedMetric(m); setSelectedField(null); }}
                  >
                    <div className="wbuilder-metric-tile-name">{m.label}</div>
                    <div className="wbuilder-metric-tile-sub">{m.numericFields.length} metric{m.numericFields.length !== 1 ? 's' : ''} available</div>
                    <div className="wbuilder-metric-tile-count">{m.rows} rows</div>
                  </div>
                ))}
              </div>
            </>
          )}

          {step === 1 && selectedMetric && (
            <>
              <div className="wbuilder-q">Which metric should the chart show?</div>
              <div className="wbuilder-hint">Numeric fields from {selectedMetric.label}.</div>
              <div className="wbuilder-field-grid">
                {selectedMetric.numericFields.map(f => {
                  const sampleVal = selectedMetric.firstRow[f];
                  return (
                    <div
                      key={f}
                      className={`wbuilder-field-tile ${selectedField === f ? 'selected' : ''}`}
                      onClick={() => setSelectedField(f)}
                    >
                      <div className="wbuilder-field-tile-label">{FIELD_LABELS[f] || f.replace(/_/g, ' ')}</div>
                      <div className="wbuilder-field-tile-key">{f}</div>
                      <div className="wbuilder-field-tile-sample">{typeof sampleVal === 'number' ? sampleVal.toLocaleString() : sampleVal}</div>
                    </div>
                  );
                })}
              </div>
            </>
          )}

          {step === 2 && (
            <>
              <div className="wbuilder-q">How should the data be visualised?</div>
              <div className="wbuilder-hint">Pick the chart type that best tells the story.</div>
              <div className="wbuilder-chart-grid">
                {CHART_TYPES.map(ct => (
                  <div
                    key={ct.id}
                    className={`wbuilder-chart-tile ${selectedChart === ct.id ? 'selected' : ''}`}
                    onClick={() => setSelectedChart(ct.id)}
                  >
                    <div className="wbuilder-chart-tile-icon">{ct.icon}</div>
                    <div className="wbuilder-chart-tile-label">{ct.label}</div>
                    <div className="wbuilder-chart-tile-hint">{ct.hint}</div>
                  </div>
                ))}
              </div>
            </>
          )}

          {step === 3 && selectedMetric && selectedField && selectedChart && (
            <>
              <div className="wbuilder-q">Looks good ‚Äî ready to add?</div>
              <div className="wbuilder-hint">Here's a summary of the widget you're building.</div>
              <div className="wbuilder-confirm-card">
                <div className="wbuilder-confirm-row">
                  <span>Data source</span>
                  <span>{selectedMetric.label}</span>
                </div>
                <div className="wbuilder-confirm-row">
                  <span>Metric</span>
                  <span>{FIELD_LABELS[selectedField] || selectedField}</span>
                </div>
                <div className="wbuilder-confirm-row">
                  <span>Chart type</span>
                  <span>{CHART_TYPES.find(c => c.id === selectedChart)?.label}</span>
                </div>
                <div className="wbuilder-confirm-row">
                  <span>Rows</span>
                  <span>{selectedMetric.rows}</span>
                </div>
              </div>
            </>
          )}
        </div>

        <div className="wbuilder-footer">
          <button className="wbuilder-back" onClick={handleBack}>
            {step === 0 ? '‚úï Cancel' : '‚Üê Back'}
          </button>
          <button
            className="btn-primary"
            style={{ flex: 1, justifyContent: 'center' }}
            onClick={handleNext}
            disabled={!canNext}
          >
            {step < 3 ? 'Next ‚Üí' : 'Add to canvas ‚úì'}
          </button>
        </div>
      </div>
    </div>
  );
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CANVAS BUILDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CanvasBuilder = ({ onLaunch, onBack }) => {
  const [widgets, setWidgets] = useState([]);
  const [showBuilder, setShowBuilder] = useState(false);

  const chartTypeIcon = { bar: '‚ñä', hbar: '‚ñ¨', line: 'üìà', donut: '‚óé' };

  return (
    <div className="canvas-builder">
      <div className="cb-header">
        <button className="cb-back" onClick={onBack}><Icon name="back" /></button>
        <div style={{ flex: 1 }}>
          <div style={{ fontFamily: 'var(--font-display)', fontWeight: 800, fontSize: '1rem' }}>
            Build Your Canvas
          </div>
          <div style={{ fontSize: '0.72rem', color: 'var(--text-3)' }}>
            {widgets.length === 0 ? 'No widgets yet' : `${widgets.length} widget${widgets.length !== 1 ? 's' : ''} added`}
          </div>
        </div>
        <button
          className="btn-primary"
          style={{ padding: '0.6rem 1.25rem', fontSize: '0.9rem', opacity: widgets.length === 0 ? 0.4 : 1 }}
          disabled={widgets.length === 0}
          onClick={() => onLaunch(widgets)}
        >
          Launch ‚Üí
        </button>
      </div>

      <div className="cb-grid-area">
        {widgets.length === 0 && (
          <div style={{ textAlign: 'center', padding: '3rem 1rem', color: 'var(--text-3)' }}>
            <div style={{ fontSize: '2.5rem', marginBottom: '0.75rem' }}>üß©</div>
            <div style={{ fontWeight: 700, fontSize: '1rem', color: 'var(--text-2)', marginBottom: '0.4rem' }}>
              Your canvas is empty
            </div>
            <div style={{ fontSize: '0.85rem', marginBottom: '1.5rem' }}>
              Tap the card below to add your first widget
            </div>
          </div>
        )}
        <div className="cb-grid">
          {widgets.map((w, i) => (
            <div className="cb-widget-tile" key={w.id} style={{ animationDelay: `${i * 0.05}s` }}>
              <div className="cb-tile-top">
                <div className="cb-tile-icon">{chartTypeIcon[w.chartType] || 'üìä'}</div>
                <button className="cb-tile-remove" onClick={() => setWidgets(prev => prev.filter(x => x.id !== w.id))}>
                  ‚úï
                </button>
              </div>
              <div className="cb-tile-title">{w.title}</div>
              <div className="cb-tile-meta">{w.category} ¬∑ {CHART_TYPES.find(c => c.id === w.chartType)?.label}</div>
            </div>
          ))}

          <div className="cb-add-card" onClick={() => setShowBuilder(true)}>
            <div className="cb-add-card-icon">Ôºã</div>
            <div className="cb-add-card-label">Add widget</div>
          </div>
        </div>
      </div>

      {showBuilder && (
        <WidgetBuilder
          onAdd={(cfg) => {
            setWidgets(prev => [...prev, cfg]);
            setShowBuilder(false);
          }}
          onClose={() => setShowBuilder(false)}
        />
      )}
    </div>
  );
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIDGET CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const WidgetChat = ({ widget, onClose }) => {
  const [msgs, setMsgs] = useState([]);
  const [input, setInput] = useState('');
  const [typing, setTyping] = useState(false);
  const endRef = useRef(null);
  const inputRef = useRef(null);
  const dragStart = useRef(null);
  const sheetRef = useRef(null);

  useEffect(() => { endRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [msgs, typing]);

  // Keyboard-aware: track visualViewport height
  useEffect(() => {
    if (!window.visualViewport) return;
    const onResize = () => {
      const keyboardH = window.innerHeight - window.visualViewport.height;
      document.documentElement.style.setProperty('--keyboard-h', `${keyboardH}px`);
    };
    window.visualViewport.addEventListener('resize', onResize);
    return () => {
      window.visualViewport.removeEventListener('resize', onResize);
      document.documentElement.style.setProperty('--keyboard-h', '0px');
    };
  }, []);

  // Swipe-to-dismiss
  const onTouchStart = (e) => {
    dragStart.current = e.touches[0].clientY;
    if (sheetRef.current) sheetRef.current.style.transition = 'none';
  };

  const onTouchMove = (e) => {
    if (dragStart.current === null) return;
    const dy = e.touches[0].clientY - dragStart.current;
    if (dy > 0 && sheetRef.current) {
      sheetRef.current.style.transform = `translateY(${dy}px)`;
    }
  };

  const onTouchEnd = (e) => {
    if (dragStart.current === null) return;
    const dy = e.changedTouches[0].clientY - dragStart.current;
    if (sheetRef.current) {
      sheetRef.current.style.transition = '';
      sheetRef.current.style.transform = '';
    }
    if (dy > 80) onClose();
    dragStart.current = null;
  };

  const send = useCallback(async (text) => {
    const q = text || input;
    if (!q.trim()) return;
    inputRef.current?.blur();
    setMsgs(p => [...p, { id: Date.now(), sender: 'user', text: q }]);
    setInput('');
    setTyping(true);

    const ctx = `You are an AI analyst embedded in the "${widget.title}" widget (${widget.category}) of the ABC Retail Insights+ dashboard. Data for this widget: ${JSON.stringify(widget.data)}. Full dataset context: ${JSON.stringify({ stores: D.stores, customers: D.customer_segments, inventory: D.inventory, monthly_revenue: D.monthly_revenue })}. Be concise, specific, and actionable. Use LKR currency. Answer only from the data provided.`;

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: q, context: ctx })
      });
      const data = await res.json();
      setTyping(false);
      setMsgs(p => [...p, { id: Date.now(), sender: 'ai', text: data.reply || 'No response.' }]);
    } catch (err) {
      setTyping(false);
      setMsgs(p => [...p, { id: Date.now(), sender: 'ai', text: 'Connection error. Please try again.' }]);
    }
  }, [input, widget]);

  return (
    <div className={`wchat-overlay open`} onClick={onClose}>
      <div
        className="wchat-sheet"
        ref={sheetRef}
        onClick={e => e.stopPropagation()}
        onTouchStart={onTouchStart}
        onTouchMove={onTouchMove}
        onTouchEnd={onTouchEnd}
      >
        <div className="wchat-head">
          <div>
            <div className="wchat-head-label">{widget.category}</div>
            <div className="wchat-head-title">{widget.title}</div>
          </div>
          <button className="wchat-close" onClick={onClose}><Icon name="close" /></button>
        </div>

        <div className="wchat-messages">
          {msgs.length === 0 && (
            <div className="wchat-empty">
              <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>‚óà</div>
              <div className="wchat-empty-title">Ask about {widget.title}</div>
              <div className="wchat-empty-sub">I have full context of this widget's data</div>
              <div className="suggestions">
                {(widget.suggestions || []).map((s, i) => (
                  <button key={i} className="suggestion-chip" onClick={() => send(s)}>{s}</button>
                ))}
              </div>
            </div>
          )}

          {msgs.map(m => (
            <div key={m.id} className={`msg ${m.sender}`}>
              <div className="msg-avatar">{m.sender === 'ai' ? '‚óà' : '‚óè'}</div>
              <div className="msg-bubble" dangerouslySetInnerHTML={{ __html: renderMd(m.text) }} />
            </div>
          ))}

          {typing && (
            <div className="msg ai">
              <div className="msg-avatar">‚óà</div>
              <div className="msg-bubble" style={{ padding: '0.65rem 0.9rem' }}>
                <div className="typing-dots">
                  <div className="dot" /><div className="dot" /><div className="dot" />
                </div>
              </div>
            </div>
          )}
          <div ref={endRef} />
        </div>

        <div className="wchat-input-row">
          <input
            ref={inputRef}
            className="wchat-field"
            placeholder={`Ask about ${widget.title}‚Ä¶`}
            value={input}
            onChange={e => setInput(e.target.value)}
            onKeyDown={e => e.key === 'Enter' && send()}
            autoFocus
          />
          <button className="wchat-send" onClick={() => send()} disabled={!input.trim() || typing}>
            <Icon name="send" size={13} />
          </button>
        </div>
      </div>
    </div>
  );
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHART FACTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Chart = ({ type, data, cfg = {} }) => {
  const tt = { contentStyle: { background: '#1c2130', border: '1px solid rgba(255,255,255,0.08)', borderRadius: 8, fontSize: 12, color: '#fff' }, cursor: { fill: 'rgba(255,255,255,0.04)' } };

  if (!data?.length) return <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', color: 'var(--text-3)', fontSize: '0.8rem' }}>No data</div>;

  switch (type) {
    case 'bar':
      return (
        <ResponsiveContainer width="100%" height="100%">
          <BarChart data={data} margin={{ top: 4, right: 4, bottom: 0, left: -20 }}>
            <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" vertical={false} />
            <XAxis dataKey={cfg.x || 'name'} tick={{ fill: '#5c6480', fontSize: 10 }} axisLine={false} tickLine={false} />
            <YAxis tick={{ fill: '#5c6480', fontSize: 10 }} axisLine={false} tickLine={false} tickFormatter={v => fmt(v)} />
            <Tooltip {...tt} />
            <Bar dataKey={cfg.y || 'value'} fill={PALETTE[0]} radius={[4, 4, 0, 0]}>
              {data.map((_, i) => <Cell key={i} fill={PALETTE[i % PALETTE.length]} />)}
            </Bar>
          </BarChart>
        </ResponsiveContainer>
      );

    case 'hbar':
      return (
        <ResponsiveContainer width="100%" height="100%">
          <BarChart data={data} layout="vertical" margin={{ top: 4, right: 8, bottom: 0, left: 8 }}>
            <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" horizontal={false} />
            <XAxis type="number" tick={{ fill: '#5c6480', fontSize: 10 }} axisLine={false} tickLine={false} tickFormatter={v => fmt(v)} />
            <YAxis type="category" dataKey={cfg.y || 'name'} tick={{ fill: '#8892aa', fontSize: 10 }} axisLine={false} tickLine={false} width={80} />
            <Tooltip {...tt} />
            <Bar dataKey={cfg.x || 'value'} fill={PALETTE[0]} radius={[0, 4, 4, 0]}>
              {data.map((_, i) => <Cell key={i} fill={PALETTE[i % PALETTE.length]} />)}
            </Bar>
          </BarChart>
        </ResponsiveContainer>
      );

    case 'line':
      return (
        <ResponsiveContainer width="100%" height="100%">
          <LineChart data={data} margin={{ top: 4, right: 8, bottom: 0, left: -20 }}>
            <CartesianGrid strokeDasharray="3 3" stroke="rgba(255,255,255,0.05)" vertical={false} />
            <XAxis dataKey={cfg.x || 'name'} tick={{ fill: '#5c6480', fontSize: 10 }} axisLine={false} tickLine={false} />
            <YAxis tick={{ fill: '#5c6480', fontSize: 10 }} axisLine={false} tickLine={false} tickFormatter={v => fmt(v)} />
            <Tooltip {...tt} />
            {(cfg.lines || [cfg.y || 'value']).map((k, i) => (
              <Line key={k} type="monotone" dataKey={k} stroke={PALETTE[i]} strokeWidth={2} dot={{ fill: PALETTE[i], r: 3 }} activeDot={{ r: 5 }} />
            ))}
          </LineChart>
        </ResponsiveContainer>
      );

    case 'donut':
      return (
        <ResponsiveContainer width="100%" height="100%">
          <PieChart>
            <Pie data={data} cx="50%" cy="50%" innerRadius="45%" outerRadius="70%" paddingAngle={3} dataKey={cfg.value || 'value'} nameKey={cfg.name || 'name'}>
              {data.map((_, i) => <Cell key={i} fill={PALETTE[i % PALETTE.length]} />)}
            </Pie>
            <Tooltip {...tt} />
            <Legend iconSize={8} formatter={v => <span style={{ color: '#8892aa', fontSize: 11 }}>{v}</span>} />
          </PieChart>
        </ResponsiveContainer>
      );

    default:
      return null;
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WIDGET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Widget = ({ config, wide }) => {
  const [chatOpen, setChatOpen] = useState(false);

  return (
    <>
      <div className={`widget${wide ? ' widget-wide' : ''}`}>
        <div className="widget-head">
          <div>
            <div className="widget-category">{config.category}</div>
            <div className="widget-title">{config.title}</div>
            {config.kpi && <div className="widget-kpi">{config.kpi}</div>}
            {config.kpiSub && <div className="widget-kpi-sub">{config.kpiSub}</div>}
            {config.trend && (
              <span className={`trend ${config.trend > 0 ? 'up' : 'down'}`}>
                <Icon name={config.trend > 0 ? 'up' : 'down'} size={9} /> {Math.abs(config.trend)}%
              </span>
            )}
          </div>
          <button className="widget-chat-btn" onClick={() => setChatOpen(true)} title="Ask AI">‚óà</button>
        </div>
        <div className="widget-chart">
          <Chart type={config.chartType} data={config.data} cfg={config.chartCfg} />
        </div>
      </div>

      {chatOpen && <WidgetChat widget={config} onClose={() => setChatOpen(false)} />}
    </>
  );
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL CHAT DRAWER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ChatDrawer = ({ open, onClose }) => {
  const [msgs, setMsgs] = useState([]);
  const [input, setInput] = useState('');
  const [typing, setTyping] = useState(false);
  const endRef = useRef(null);
  const inputRef = useRef(null);
  const dragStart = useRef(null);
  const drawerRef = useRef(null);

  useEffect(() => { endRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [msgs, typing]);

  // Keyboard-aware: visualViewport
  useEffect(() => {
    if (!window.visualViewport) return;
    const onResize = () => {
      const keyboardH = window.innerHeight - window.visualViewport.height;
      document.documentElement.style.setProperty('--keyboard-h', `${keyboardH}px`);
    };
    if (open) {
      window.visualViewport.addEventListener('resize', onResize);
    }
    return () => {
      window.visualViewport.removeEventListener('resize', onResize);
      if (!open) document.documentElement.style.setProperty('--keyboard-h', '0px');
    };
  }, [open]);

  // Swipe-to-dismiss
  const onTouchStart = (e) => {
    dragStart.current = e.touches[0].clientY;
    if (drawerRef.current) drawerRef.current.style.transition = 'none';
  };

  const onTouchMove = (e) => {
    if (dragStart.current === null) return;
    const dy = e.touches[0].clientY - dragStart.current;
    if (dy > 0 && drawerRef.current) {
      drawerRef.current.style.transform = `translateY(${dy}px)`;
    }
  };

  const onTouchEnd = (e) => {
    if (dragStart.current === null) return;
    const dy = e.changedTouches[0].clientY - dragStart.current;
    if (drawerRef.current) {
      drawerRef.current.style.transition = '';
      drawerRef.current.style.transform = open ? 'translateY(0)' : 'translateY(100%)';
    }
    if (dy > 80) onClose();
    dragStart.current = null;
  };

  const send = useCallback(async (text) => {
    const q = text || input;
    if (!q.trim()) return;
    inputRef.current?.blur();
    setMsgs(p => [...p, { id: Date.now(), sender: 'user', text: q }]);
    setInput('');
    setTyping(true);

    const ctx = `You are an AI retail analyst for ${D.meta.company}, a ${D.meta.industry} retailer. You have access to the full dataset: ${JSON.stringify(D)}. Answer questions concisely and specifically using this data. Be actionable. Use LKR currency. Do not fabricate data not in the context. Format key numbers in bold.`;

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: q, context: ctx })
      });
      const data = await res.json();
      setTyping(false);
      setMsgs(p => [...p, { id: Date.now(), sender: 'ai', text: data.reply || 'No response.' }]);
    } catch (err) {
      setTyping(false);
      setMsgs(p => [...p, { id: Date.now(), sender: 'ai', text: 'Connection error. Please try again.' }]);
    }
  }, [input]);

  const starters = [
    "Which store is performing best?",
    "Where are we overstocked?",
    "How are VIP customers trending?",
    "What drove June revenue growth?"
  ];

  return (
    <>
      <div className={`chat-drawer-overlay ${open ? 'open' : ''}`} onClick={onClose} />
      <div
        ref={drawerRef}
        className={`chat-drawer ${open ? 'open' : ''}`}
        onTouchStart={onTouchStart}
        onTouchMove={onTouchMove}
        onTouchEnd={onTouchEnd}
      >
        <div className="drawer-handle" />
        <div className="drawer-head">
          <div className="drawer-head-info">
            <div className="drawer-head-label">AI Analyst</div>
            <div className="drawer-head-title">Chat with your data</div>
          </div>
          <button className="drawer-close" onClick={onClose}><Icon name="close" /></button>
        </div>

        <div className="drawer-messages">
          {msgs.length === 0 && (
            <div style={{ padding: '0.5rem 0' }}>
              <p style={{ fontSize: '0.85rem', color: 'var(--text-2)', marginBottom: '1rem' }}>
                Ask anything across all {D.tables.length} datasets. Try:
              </p>
              <div className="suggestions" style={{ justifyContent: 'flex-start' }}>
                {starters.map((s, i) => (
                  <button key={i} className="suggestion-chip" onClick={() => send(s)}>{s}</button>
                ))}
              </div>
            </div>
          )}

          {msgs.map(m => (
            <div key={m.id} className={`msg ${m.sender}`}>
              <div className="msg-avatar">{m.sender === 'ai' ? '‚óà' : '‚óè'}</div>
              <div className="msg-bubble" dangerouslySetInnerHTML={{ __html: renderMd(m.text) }} />
            </div>
          ))}

          {typing && (
            <div className="msg ai">
              <div className="msg-avatar">‚óà</div>
              <div className="msg-bubble">
                <div className="typing-dots">
                  <div className="dot" /><div className="dot" /><div className="dot" />
                </div>
              </div>
            </div>
          )}
          <div ref={endRef} />
        </div>

        <div className="drawer-input">
          <div className="drawer-input-wrap">
            <input
              ref={inputRef}
              className="drawer-input-field"
              placeholder="Ask about your data‚Ä¶"
              value={input}
              onChange={e => setInput(e.target.value)}
              onKeyDown={e => e.key === 'Enter' && send()}
            />
          </div>
          <button className="drawer-send" onClick={() => send()} disabled={!input.trim() || typing}>
            <Icon name="send" size={13} />
          </button>
        </div>
      </div>
    </>
  );
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CANVAS ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const buildWidgets = () => {
  const totalRevenue = D.monthly_revenue.reduce((s, m) => s + m.revenue, 0);
  const lastMonth = D.monthly_revenue[D.monthly_revenue.length - 1];
  const prevMonth = D.monthly_revenue[D.monthly_revenue.length - 2];
  const revGrowth = Math.round(((lastMonth.revenue - prevMonth.revenue) / prevMonth.revenue) * 100);

  return [
    {
      id: 'revenue-trend',
      category: 'Revenue',
      title: 'Monthly Revenue Trend',
      kpi: fmt(totalRevenue, 'LKR '),
      kpiSub: 'Jan ‚Äì Jun 2024',
      trend: revGrowth,
      chartType: 'line',
      data: D.monthly_revenue,
      chartCfg: { x: 'month', lines: ['revenue', 'returns'] },
      wide: true,
      suggestions: [
        "Which month had highest revenue?",
        "What's the trend in returns?",
        "How does April compare to March?"
      ]
    },
    {
      id: 'store-revenue',
      category: 'Store Performance',
      title: 'Revenue by Store',
      kpi: D.store_performance[0].store,
      kpiSub: `Top performer ¬∑ ${fmt(D.store_performance[0].revenue, 'LKR ')}`,
      trend: D.store_performance[0].variance_vs_avg,
      chartType: 'hbar',
      data: D.store_performance,
      chartCfg: { y: 'store', x: 'revenue' },
      suggestions: [
        "Which store is underperforming?",
        "What is the revenue gap between top and bottom?",
        "How does footfall correlate with revenue?"
      ]
    },
    {
      id: 'customer-segments',
      category: 'Customer Analytics',
      title: 'Customer Segments',
      kpi: `${D.customer_segments[0].pct}% VIP`,
      kpiSub: `${D.customer_segments[0].count.toLocaleString()} platinum customers`,
      chartType: 'donut',
      data: D.customer_segments.map(s => ({ name: s.segment, value: s.count })),
      chartCfg: { value: 'value', name: 'name' },
      suggestions: [
        "What is the avg basket value of VIP customers?",
        "How many customers are at risk?",
        "What's the LTV difference between VIP and Regular?"
      ]
    },
    {
      id: 'category-revenue',
      category: 'Product Mix',
      title: 'Revenue by Category',
      kpi: D.category_revenue[0].category,
      kpiSub: `Highest revenue ¬∑ ${fmt(D.category_revenue[0].revenue, 'LKR ')}`,
      trend: D.category_revenue[0].growth_pct,
      chartType: 'bar',
      data: D.category_revenue,
      chartCfg: { x: 'category', y: 'revenue' },
      suggestions: [
        "Which category has highest margin?",
        "What category is growing fastest?",
        "Is outerwear in decline?"
      ]
    },
    {
      id: 'inventory',
      category: 'Inventory',
      title: 'Stock vs Optimal Level',
      kpi: 'Tops +920 units',
      kpiSub: 'Highest overstock risk',
      chartType: 'bar',
      data: D.inventory,
      chartCfg: { x: 'category', y: 'overstock_units' },
      suggestions: [
        "Which categories are understocked?",
        "What is the overstock risk for Tops?",
        "Which categories need immediate reorder?"
      ]
    },
    {
      id: 'peak-hours',
      category: 'Operations',
      title: 'Peak Transaction Hours',
      kpi: '6PM',
      kpiSub: 'Busiest hour ¬∑ 521 transactions',
      chartType: 'bar',
      data: D.peak_hours,
      chartCfg: { x: 'hour', y: 'transactions' },
      suggestions: [
        "When should I schedule most staff?",
        "What's the slowest period of day?",
        "How does morning compare to evening?"
      ]
    }
  ];
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Dashboard = ({ widgets: customWidgets }) => {
  const [chatOpen, setChatOpen] = useState(false);
  const widgets = customWidgets || buildWidgets();

  return (
    <div className="dashboard">
      <nav className="nav">
        <div className="nav-logo">I+</div>
        <div style={{ flex: 1 }}>
          <div className="nav-title">Insights+</div>
        </div>
        <span className="nav-sub" style={{ color: 'var(--text-2)', fontSize: '0.78rem' }}>{D.meta.company}</span>
        <div className="nav-pill">‚óà AI ready</div>
      </nav>

      <div className="canvas">
        <div className="canvas-grid">
          {widgets.map((w) => (
            <Widget key={w.id} config={w} wide={w.wide} />
          ))}
        </div>
      </div>

      {/* Bottom chat bar ‚Äî tap to open drawer, no keyboard-on-tap */}
      <div className="chat-bar">
        <div className="chat-input-wrap" onClick={() => setChatOpen(true)}>
          <span style={{ fontSize: '1rem', opacity: 0.5 }}>‚óà</span>
          <span className="chat-input-placeholder">Ask anything about your data‚Ä¶</span>
        </div>
        <button className="chat-send" onClick={() => setChatOpen(true)}>
          <Icon name="send" size={13} />
        </button>
      </div>

      <ChatDrawer open={chatOpen} onClose={() => setChatOpen(false)} />
    </div>
  );
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP ROOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const App = () => {
  const [screen, setScreen] = useState('intro');
  const [customWidgets, setCustomWidgets] = useState(null);

  const handleCanvasChoice = (choice, widgets) => {
    if (choice === 'preset') {
      setCustomWidgets(null);
      setScreen('dashboard');
    } else {
      setCustomWidgets(widgets);
      setScreen('dashboard');
    }
  };

  if (screen === 'intro') return <IntroScreen onContinue={() => setScreen('login')} />;
  if (screen === 'login') return <LoginScreen onLogin={() => setScreen('discovery')} />;
  if (screen === 'discovery') return <DiscoveryScreen onBuild={() => setScreen('canvasMode')} />;
  if (screen === 'canvasMode') return (
    <CanvasModeScreen
      onPreset={() => handleCanvasChoice('preset')}
      onCustom={() => setScreen('canvasBuilder')}
    />
  );
  if (screen === 'canvasBuilder') return (
    <CanvasBuilder
      onLaunch={(widgets) => handleCanvasChoice('custom', widgets)}
      onBack={() => setScreen('canvasMode')}
    />
  );
  return <Dashboard widgets={customWidgets} />;
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
